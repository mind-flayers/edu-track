# Firestore Database Structure (detailed, authoritative)

This document describes the exact Firestore structure created by `db/populate_database.js`. It lists the top-level collections, nested subcollections, document IDs, field names, types, example values, and the conventions that the rest of the app (and future scripts) rely on.

## Top-level collections

- `admins` — primary tenant collection. Each admin (academy) uses their UID as the document ID and stores all academy-scoped data under this document via subcollections.
- `whatsapp_queue` — global queue for outgoing WhatsApp messages (used by external bots/services).

## Collection: `admins` (per-admin root)

Each admin document ID is the admin's Firebase Auth UID. Example admin used by the seeder: `jGTyDPHBwRaVVAwN2YtHysDQJP23`.

Path root: `admins/{adminUid}`

Subcollections under each admin document (as created by the seed script):

- `adminProfile` (single document)
    - Document ID: `profile`
    - Fields:
        - `name` (string) — Admin's full name. Example: `N. M. Ihthisham`.
        - `academyName` (string) — Academy display name. Example: `MEC Kanamoolai`.
        - `email` (string) — Admin email. Example: `mishaf1106@gmail.com`.
        - `profilePhotoUrl` (string) — Public URL to profile photo (Cloudinary). Example: `https://res.cloudinary.com/.../profile_1745266371005.jpg`.
        - `smsGatewayToken` (string) — Optional token for SMS gateway integration. Seed writes empty string.
        - `whatsappGatewayToken` (string) — Optional token for WhatsApp gateway integration. Seed writes empty string.
        - `createdAt` (timestamp / Date) — When the profile was created. Seed writes `new Date('2025-08-20')`.
        - `updatedAt` (timestamp / Date) — Last update timestamp. Seed sets same as createdAt.

- `academySettings` (single document) — **Academy Configuration**
    - Document ID: `subjects`
    - Path: `admins/{adminUid}/academySettings/subjects`
    - Fields:
        - `subjects` (array[string]) — List of all subjects offered by this academy. Example: `['Mathematics','Science','English','History','ICT','Tamil','Sinhala','Commerce']`.
        - `createdAt` (timestamp / Date) — When the subjects list was created.
        - `updatedAt` (timestamp / Date) — Last update timestamp.
        - `updatedBy` (string) — Admin UID who last modified the subjects list.

- `examTerms` (multiple documents)
    - Document ID: auto-generated by Firestore (addDoc()). The seed stores the generated IDs in a local map `termIdMap` and writes them to student `examResults.term` fields.
    - Fields:
        - `name` (string) — Human-readable term name, e.g. `First Term - 2025`.
        - `startDate` (timestamp / Date) — Term start date (seed uses `new Date('2025-02-01')`, etc.).
        - `endDate` (timestamp / Date) — Term end date.
        - `subjects` (array[string]) — Subjects covered in the term. Seed uses `['Mathematics','Science','English','History','ICT','Tamil','Sinhala','Commerce']`.

- `teachers` (multiple documents)
    - Document ID: auto-generated by Firestore (addDoc()).
    - Fields (seed examples included):
        - `name` (string) — e.g. `Mr. Mohamed Fazil`.
        - `email` (string) — e.g. `m.fazil@meckanamoolai.lk`.
        - `phoneNumber` (string) — e.g. `0775101101`.
        - `whatsappNumber` (string) — e.g. `0775101101`.
        - `subject` (string) — e.g. `Mathematics`.
        - `classAssigned` (array[string]) — e.g. `['Grade 9','Grade 10','Grade 11']`.
        - `joinedAt` (timestamp / Date) — seed sets to the `seedDate` (`2025-08-20`).
        - `isActive` (boolean) — seed sets to `true`.

- `students` (multiple documents)
    - Document ID: seeded as `student_<timestamp>_<index>` (string). Example pattern: `student_169253..._0`.
    - Top-level student fields (per seed script):
        - `name` (string) — Student full name.
        - `class` (string) — e.g. `Grade 10`.
        - `Subjects` (array[string]) — NOTE: capitalized `Subjects` key. Seed uses per-student subject lists like `['Mathematics','Science','English','History','ICT']`.
        - `section` (string) — e.g. `A` or `B`.
        - `dob` (timestamp / Date) — Date of birth (seed uses `new Date('<YYYY-MM-DD>')`).
        - `sex` (string) — `Male` or `Female`.
        - `indexNumber` (string) — Generated ID following the app's index format: `MEC/{YY}/{classCode}/{rowNumber}`. The seeder's `generateIndexNumber(2025, 'Grade 10', 'A', 1)` returns `MEC/25/10A/01`.
        - `parentName` (string)
        - `parentPhone` (string)
        - `whatsappNumber` (string)
        - `address` (string)
        - `photoUrl` (string) — Cloudinary stub used by seed.
        - `qrCodeData` (string) — Seed sets this to the document ID (studentId). Used as the unique QR payload.
        - `joinedAt` (timestamp / Date) — seed sets to `seedDate`.
        - `isActive` (boolean) — seed sets to `true`.
        - `isNonePayee` (boolean) — Flag indicating if this student is exempt from fees. Seed sets `true` for first 2 students, `false` for others.

    Student subcollections created by the seed script:

    - `attendance` (multiple documents)
        - Document ID: auto-generated by addDoc().
        - Fields:
            - `date` (string) — ISO date in `YYYY-MM-DD` format (seed uses strings like `2025-08-20`).
            - `subject` (string) — Subject for that attendance entry. Seed computes this using a weekday-to-subject schedule function.
            - `status` (string) — `present` (seed only writes present records; absence is implied by no doc).
            - `markedBy` (string) — Admin UID who marked attendance (seed writes the same `adminId`).
            - `markedAt` (timestamp / Date) — Exact DateTime for the class: `new Date(`${date}T${timeSlot}:00`)`.

    - `fees` (multiple documents)
        - Document ID: auto-generated by addDoc().
        - Fields:
            - `paymentType` (string) — Type of payment: `monthly` or `daily`.
            - `year` (number) — e.g. `2025`.
            - `month` (number) — 1-12 (for both monthly and daily payments).
            - `date` (string | null) — ISO date string `YYYY-MM-DD` for daily payments (e.g. `2025-08-20`). `null` for monthly payments.
            - `subjects` (array[string]) — List of subjects this payment covers. Example: `['Mathematics','Science','English']`.
            - `amount` (number) — Payment amount. Example: `2500` for monthly, `150` for daily.
            - `status` (string) — Payment status: `PAID` or `PENDING`.
            - `paidAt` (timestamp | null) — Date object when payment was completed. `null` if status is `PENDING`.
            - `pendingAt` (timestamp | null) — Date object when payment was marked as pending. `null` if status is `PAID`.
            - `paymentMethod` (string | null) — e.g. `Manual/QR`, `Bank Transfer`, `cash`. `null` if status is `PENDING`.
            - `markedBy` (string) — Admin UID who created or updated the payment record.
            - `description` (string) — Human-readable description. Example: `Monthly fee for Mathematics, Science, English - August 2025` or `Daily class fee for Mathematics - 2025-08-20`.

    - `examResults` (multiple documents)
        - Document ID: auto-generated by addDoc().
        - Fields:
            - `term` (string | null) — The Firestore document ID of the corresponding `examTerms/{termId}` document (seed stores `termIdMap[termName]` or `null`).
            - `subject` (string) — e.g. `Mathematics`.
            - `marks` (number) — e.g. `72 + (i % 6)`.
            - `maxMarks` (number) — seed uses `100`.
            - `resultDate` (timestamp / Date) — e.g. `new Date('2025-04-15')`.
            - `updatedBy` (string) — Admin UID.

- `attendanceSummary` (multiple documents)
    - Document ID: date string in `YYYY-MM-DD` format (the seed uses the same attendanceDates array values).
    - Fields:
        - `class` (string) — e.g. `Overall` or a specific class name.
        - `present` (number) — Count of present students for that date/class.
        - `studentsPresent` (array[string]) — Array of student document IDs who were present.
        - `markedBy` (string) — Admin UID who created the summary.
        - `markedAt` (timestamp / Date) — DateTime when summary was created (`new Date(`${date}T08:00:00`)` in seed).

## Collection: `whatsapp_queue`

- Document ID: auto-generated by addDoc().
- Fields (this seed script does not write to this collection, but the README and other scripts reference it):
    - `to` (string) — Recipient number e.g. `+94771234567`.
    - `message` (string) — Text content to send.
    - `status` (string) — `pending` | `sent` | `failed`.
    - `createdAt` (timestamp / Date)
    - `sentAt` (timestamp | null)
    - `error` (string | null)

## Seeder conventions and implementation notes (authoritative)

- **Timestamps in seed**: the script uses JavaScript Date objects (e.g. `new Date('2025-08-20')` or `new Date(`${date}T${timeSlot}:00`)`) — these become Firestore timestamp values when written via the Firebase SDK.
- **Student subjects**: stored under the property name `Subjects` (capital "S"). Other parts of the app may expect `subjects` lowercase; be careful when querying or migrating seed data.
- **Academy subjects management**: the seeder creates an `academySettings/subjects` document containing the official subjects list for the academy.
- **Payment system**: uses a new status-based system with `status: 'PAID'|'PENDING'` instead of the old `paid: boolean`. Each payment record includes `paymentType` ('monthly'|'daily'), `subjects` array, and descriptive `description` field.
- **None payee students**: the seeder marks the first 2 students with `isNonePayee: true` for testing purposes. These students are exempt from fee payments.
- **Attendance**: the seed only creates attendance documents for present students. Absence is inferred by the absence of a document for a given student/date. Each attendance document includes both a `date` string (YYYY-MM-DD) and a `markedAt` timestamp for convenience in filtering and sorting.
- **Exam terms**: `examResults.term` stores the `examTerms/{termId}` document ID (string), not a DocumentReference. Code that needs the actual term document must fetch it separately using that ID.
- **Index number generation**: mirrors the Flutter app's logic and uses the pattern `MEC/{YY}/{classCode}/{rowNumber}`. The seed uses `generateIndexNumber(2025, className, section, rowNumber)`.
- **Enhanced seeding**: creates both monthly payments (June, July, August) and daily payments (selective dates) with mixed `PAID`/`PENDING` statuses (~80% PAID, ~20% PENDING).

## Example document tree (compact)

admins/{adminUid}
    ├─ adminProfile/profile
    │   ├ name: string
    │   ├ academyName: string
    │   └ updatedAt: timestamp
    ├─ academySettings/subjects
    │   ├ subjects: array[string]
    │   ├ createdAt: timestamp
    │   └ updatedBy: string
    ├─ examTerms/{termId}
    │   ├ name: string
    │   ├ startDate: timestamp
    │   └ subjects: array[string]
    ├─ teachers/{teacherId}
    │   ├ name: string
    │   ├ subject: string
    │   └ isActive: boolean
    ├─ students/{studentId}
    │   ├ name: string
    │   ├ Subjects: array[string]
    │   ├ indexNumber: string
    │   ├ qrCodeData: string
    │   ├ isNonePayee: boolean
    │   ├ attendance/{autoId} -> { date:string, subject:string, status:'present', markedBy, markedAt }
    │   ├ fees/{autoId} -> { paymentType, year, month, date, subjects, amount, status, paidAt, pendingAt, paymentMethod, description, markedBy }
    │   └ examResults/{autoId} -> { term:termId, subject, marks, maxMarks, resultDate, updatedBy }
    └─ attendanceSummary/{YYYY-MM-DD} -> { class, present, studentsPresent, markedBy, markedAt }

## Quick rules for downstream code and migrations

- **Absence tracking**: When counting absences, query by checking presence of attendance records for the target date — do not assume an explicit `absent` field exists.
- **Exam term display**: When displaying exam term names in UI, fetch `examTerms/{termId}` using the `term` ID stored in student `examResults`.
- **Subject consistency**: Maintain the `Subjects` uppercase key consistency if you rely on seeded documents; prefer writing code to normalize subject keys when reading/writing production data.
- **Payment status**: Use the new `status` field (`PAID`|`PENDING`) instead of the deprecated `paid` boolean for payment queries and filtering.
- **None payee handling**: Check `isNonePayee` flag before showing payment-related UI or creating fee records for students.
- **Academy subjects**: Query `academySettings/subjects` document to get the official subjects list instead of hardcoding subject names.

---

## Requirements coverage & Seed Statistics

- **Database structure extraction**: Complete - all collections, subcollections, and fields documented
- **Academy subjects management**: `academySettings/subjects` document with 8 subjects (Mathematics, Science, English, History, ICT, Tamil, Sinhala, Commerce)
- **Enhanced payment system**: New `status`-based system (`PAID`/`PENDING`) with `paymentType`, `subjects`, and `description` fields
- **Student diversity**: 10 students with 2 marked as `isNonePayee: true` for testing
- **Payment records**: ~40 total records (30 monthly + 10 daily) with mixed statuses (~80% PAID, ~20% PENDING)
- **Exam terms**: 3 terms covering all academy subjects
- **Teachers**: 4 active teachers with subject specializations
- **Attendance tracking**: Present-only system (absence inferred by missing documents)

**Script changes integrated:**
- ✅ NEW `academySettings/subjects` management
- ✅ Subject names updated from 'Maths' → 'Mathematics' 
- ✅ NEW `isNonePayee` student flag
- ✅ MAJOR payment system overhaul (status, paymentType, subjects, etc.)
- ✅ Enhanced seeding with diverse payment scenarios
- ✅ Updated documentation structure and examples

